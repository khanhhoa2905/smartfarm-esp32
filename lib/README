
# ğŸŒ± SmartFarm ESP32 â€“ Há»‡ thá»‘ng nÃ´ng tráº¡i thÃ´ng minh IoT

> GiÃ¡m sÃ¡t mÃ´i trÆ°á»ng â€“ tÆ°á»›i tiÃªu â€“ thÃ´ng giÃ³ â€“ phÃ¡t hiá»‡n chÃ¡y â€“ cáº£nh bÃ¡o Email/Telegram  
> Sá»­ dá»¥ng **ESP32 + MQTT (EMQX) + Node-RED Dashboard**

---

## 1. Giá»›i thiá»‡u & Äáº·t váº¥n Ä‘á»

Trong cÃ¡c mÃ´ hÃ¬nh nÃ´ng nghiá»‡p hiá»‡n Ä‘áº¡i, viá»‡c **giÃ¡m sÃ¡t vÃ  Ä‘iá»u khiá»ƒn mÃ´i trÆ°á»ng** (nhiá»‡t Ä‘á»™, Ä‘á»™ áº©m, Ä‘á»™ áº©m Ä‘áº¥t, cháº¥t lÆ°á»£ng khÃ´ng khÃ­, má»±c nÆ°á»›câ€¦) thÆ°á»ng Ä‘Æ°á»£c thá»±c hiá»‡n thá»§ cÃ´ng, phá»¥ thuá»™c vÃ o kinh nghiá»‡m ngÆ°á»i váº­n hÃ nh. Äiá»u nÃ y dá»… dáº«n tá»›i:

- TÆ°á»›i nÆ°á»›c khÃ´ng há»£p lÃ½ â†’ lÃ£ng phÃ­ nÆ°á»›c, cÃ¢y bá»‹ Ãºng hoáº·c khÃ´.
- KhÃ´ng phÃ¡t hiá»‡n ká»‹p thá»i khi **chÃ¡y**, **rÃ² rá»‰ khÃ­ Ä‘á»™c**, thiáº¿u nÆ°á»›c trong bá»ƒ chá»©a.
- KhÃ´ng cÃ³ dá»¯ liá»‡u **ghi log** Ä‘á»ƒ phÃ¢n tÃ­ch, tá»‘i Æ°u trong dÃ i háº¡n.

Dá»± Ã¡n **SmartFarm ESP32** hÆ°á»›ng tá»›i má»™t há»‡ thá»‘ng **tá»± Ä‘á»™ng hoÃ n toÃ n**:

- Äá»c dá»¯ liá»‡u tá»« nhiá»u loáº¡i cáº£m biáº¿n.
- Ra quyáº¿t Ä‘á»‹nh Ä‘iá»u khiá»ƒn bÆ¡m, quáº¡t, Ä‘Ã¨n, cÃ²i, servo má»™t cÃ¡ch **tá»± Ä‘á»™ng** theo ká»‹ch báº£n.
- Gá»­i dá»¯ liá»‡u thá»i gian thá»±c lÃªn **EMQX (MQTT broker)**.
- Hiá»ƒn thá»‹ dashboard Ä‘áº¹p máº¯t vá»›i **Node-RED Dashboard**.
- Ghi log file CSV Ä‘á»ƒ phÃ¢n tÃ­ch.
- Gá»­i **cáº£nh bÃ¡o tá»©c thá»i** vÃ  **bÃ¡o cÃ¡o Ä‘á»‹nh ká»³** qua **Email + Telegram Bot**.

Há»‡ thá»‘ng nÃ y cÃ³ thá»ƒ triá»ƒn khai cho:
- MÃ´ hÃ¬nh nÃ´ng tráº¡i nhá», nhÃ  kÃ­nh, vÆ°á»n rau ban cÃ´ng.
- MÃ´ phá»ng â€“ demo cho mÃ´n há»c **Internet of Things**, **Há»‡ thá»‘ng nhÃºng**, **Máº¡ng cáº£m biáº¿n**â€¦

---

## 2. Chá»©c nÄƒng chÃ­nh

### 2.1. GiÃ¡m sÃ¡t mÃ´i trÆ°á»ng

ESP32 Ä‘á»c dá»¯ liá»‡u tá»« cÃ¡c cáº£m biáº¿n:

- **DHT11** â€“ nhiá»‡t Ä‘á»™ & Ä‘á»™ áº©m khÃ´ng khÃ­.
- **Cáº£m biáº¿n Ä‘á»™ áº©m Ä‘áº¥t** â€“ analog (0â€“4095) Ä‘Æ°á»£c chuyá»ƒn sang % Ä‘á»™ áº©m.
- **MQ135** â€“ cháº¥t lÆ°á»£ng khÃ´ng khÃ­ / khÃ­ gas â†’ quy Ä‘á»•i % má»©c cáº£nh bÃ¡o.
- **Cáº£m biáº¿n lá»­a (flame sensor)** â€“ phÃ¡t hiá»‡n lá»­a (active LOW).
- **PIR** â€“ cáº£m biáº¿n chuyá»ƒn Ä‘á»™ng ngÆ°á»i.
- **Module Ã¡nh sÃ¡ng (LDR)** â€“ phÃ¡t hiá»‡n sÃ¡ng/tá»‘i (ngÃµ ra sá»‘).
- **Cáº£m biáº¿n siÃªu Ã¢m** â€“ Ä‘o má»±c nÆ°á»›c trong bá»ƒ (chuyá»ƒn sang % dung tÃ­ch).
- **RFID RC522** â€“ kiá»ƒm soÃ¡t ra vÃ o (tháº» há»£p lá»‡ / khÃ´ng há»£p lá»‡).

Dá»¯ liá»‡u Ä‘Æ°á»£c Ä‘Ã³ng gÃ³i JSON vÃ  publish lÃªn topic:

```text
smartfarm/data
````

cÃ³ dáº¡ng:

```json
{
  "temperature": 25.5,
  "humidity": 60.2,
  "soil": 1350,
  "gas": 180,
  "fire": false,
  "motion": true,
  "light": false,
  "waterPercent": 61.2,
  "led": 1,
  "pump": 0,
  "fan": 1,
  "uid": "D062C25F"
}
```

### 2.2. Äiá»u khiá»ƒn tá»± Ä‘á»™ng

Thuáº­t toÃ¡n Ä‘iá»u khiá»ƒn (cháº¡y trÃªn ESP32):

* **PhÃ¡t hiá»‡n chÃ¡y**

  * `fire == true` (cáº£m biáº¿n lá»­a active LOW):

    * Báº­t **cÃ²i** (buzzer).
    * Báº­t **bÆ¡m** phun nÆ°á»›c chá»¯a chÃ¡y.
    * Dá»«ng chuyá»ƒn Ä‘á»™ng **servo** (cáº£m biáº¿n lá»­a dá»«ng á»Ÿ vá»‹ trÃ­ phÃ¡t hiá»‡n).
    * Gá»­i cáº£nh bÃ¡o lÃªn MQTT (`smartfarm/alert`).
  * Khi khÃ´ng cÃ²n chÃ¡y:

    * Táº¯t cÃ²i, táº¯t bÆ¡m.
    * Servo tiáº¿p tá»¥c quÃ©t.

* **TÆ°á»›i nÆ°á»›c tá»± Ä‘á»™ng**

  * Äáº¥t **khÃ´** (vÃ­ dá»¥ `soil% < 30`) vÃ  bá»ƒ nÆ°á»›c **cÃ²n Ä‘á»§** (`water% > 20`):

    * Báº­t **bÆ¡m** tÆ°á»›i.
  * Äáº¥t Ä‘á»§ áº©m hoáº·c nÆ°á»›c tháº¥p:

    * Táº¯t bÆ¡m, náº¿u nÆ°á»›c < 20% thÃ¬ gá»­i cáº£nh bÃ¡o â€œWater tank lowâ€.

* **ThÃ´ng giÃ³ / hÃºt khÃ­**

  * Má»©c gas tá»« MQ135 > ngÆ°á»¡ng (vÃ­ dá»¥ `gas% > 70`) **hoáº·c**
  * Nhiá»‡t Ä‘á»™ > 35Â°C **vÃ ** cÃ³ ngÆ°á»i trong khu vá»±c:

    * Báº­t **quáº¡t**.
  * NgÆ°á»£c láº¡i táº¯t quáº¡t.

* **Chiáº¿u sÃ¡ng**

  * CÃ³ ngÆ°á»i (PIR = true) **vÃ ** trá»i tá»‘i (LDR = tá»‘i):

    * Báº­t **Ä‘Ã¨n**.
  * Náº¿u khÃ´ng cÃ³ ngÆ°á»i hoáº·c trá»i sÃ¡ng:

    * Táº¯t Ä‘Ã¨n.

* **RFID ra/vÃ o**

  * Äá»c UID tháº»:

    * Náº¿u thuá»™c danh sÃ¡ch **tháº» há»£p lá»‡** â†’ ghi log â€œAccess OKâ€, servo hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng.
    * Náº¿u lÃ  tháº» láº¡ â†’ ghi log â€œAccess Deniedâ€.
    * UID (hoáº·c tráº¡ng thÃ¡i OK/Denied) Ä‘Æ°á»£c gá»­i kÃ¨m trong JSON Ä‘á»ƒ hiá»ƒn thá»‹ vá» sau.

* **Servo quÃ©t vÃ¹ng lá»­a**

  * Servo SG90 quay qua láº¡i 0â€“180 Ä‘á»™.
  * Khi phÃ¡t hiá»‡n lá»­a: dá»«ng á»Ÿ vá»‹ trÃ­ hiá»‡n táº¡i (mÃ´ phá»ng hÆ°á»›ng phun nÆ°á»›c).
  * Khi háº¿t lá»­a: tiáº¿p tá»¥c quÃ©t qua láº¡i.

### 2.3. Dashboard Node-RED

* **Tab 1 â€“ SmartFarm Dashboard**

  * NhÃ³m **Environment Sensors**: 5 gauge (nhiá»‡t Ä‘á»™, Ä‘á»™ áº©m, Ä‘á»™ áº©m Ä‘áº¥t %, gas %, má»±c nÆ°á»›c %).
  * NhÃ³m **Status**: tráº¡ng thÃ¡i Fire / Motion / Light.
  * NhÃ³m **Devices**: hiá»ƒn thá»‹ tráº¡ng thÃ¡i LED, Pump, Fan, Fire, Motion, Light.

* **Tab 2 â€“ SmartFarm Charts**

  * 5 Ä‘á»“ thá»‹ thá»i gian thá»±c:

    * Nhiá»‡t Ä‘á»™ (Â°C)
    * Äá»™ áº©m khÃ´ng khÃ­ (%)
    * Äá»™ áº©m Ä‘áº¥t (%)
    * Gas (%)
    * Má»±c nÆ°á»›c bá»ƒ (%)

* **Ghi log CSV** trÃªn PC:

  * Má»—i báº£n tin dá»¯ liá»‡u sáº½ Ä‘Æ°á»£c ná»‘i vÃ o file `smartfarm_log.csv` Ä‘á»ƒ phÃ¢n tÃ­ch sau.

### 2.4. Cáº£nh bÃ¡o Email & Telegram

Flow **SmartFarm Alerts** cÃ³ 2 cháº¿ Ä‘á»™:

1. **Tá»± Ä‘á»™ng (10 phÃºt/láº§n)**
   Má»™t node `inject` Ä‘á»‹nh ká»³ 600s láº¥y dá»¯ liá»‡u má»›i nháº¥t vÃ  gá»­i **bÃ¡o cÃ¡o tá»•ng quan**:

   * Thá»i gian, nhiá»‡t Ä‘á»™, Ä‘á»™ áº©m, gas %, soil %, water %.
   * Gá»­i cÃ¹ng lÃºc **Email** vÃ  **Telegram Bot**.

2. **Thá»§ cÃ´ng**
   NÃºt `ğŸ“¤ Send report now` trÃªn tab **SmartFarm Alerts**:

   * Báº¥m Ä‘á»ƒ gá»­i ngay bÃ¡o cÃ¡o vá»›i cÃ¡c thÃ´ng sá»‘ hiá»‡n táº¡i.

NgoÃ i ra, **cáº£nh bÃ¡o tá»©c thá»i** Ä‘Æ°á»£c kÃ­ch hoáº¡t khi:

* CÃ³ lá»­a.
* Gas > ngÆ°á»¡ng.
* Má»±c nÆ°á»›c < 20%.
* Äá»™ áº©m Ä‘áº¥t < 30%.

â†’ Há»‡ thá»‘ng táº¡o message `SmartFarm ALERT` vÃ  gá»­i Ä‘á»“ng thá»i qua Email + Telegram.

---

## 3. Kiáº¿n trÃºc há»‡ thá»‘ng

### 3.1. SÆ¡ Ä‘á»“ khá»‘i tá»•ng quan

```mermaid
flowchart LR
    subgraph Field["Khu vá»±c nÃ´ng tráº¡i"]
        DHT["DHT11<br/>Temp/Humidity"]
        SOIL["Cáº£m biáº¿n áº©m Ä‘áº¥t"]
        GAS["MQ135<br/>Gas/Air quality"]
        FIRE["Cáº£m biáº¿n lá»­a"]
        PIR["Cáº£m biáº¿n chuyá»ƒn Ä‘á»™ng PIR"]
        LDR["Cáº£m biáº¿n Ã¡nh sÃ¡ng"]
        US["Cáº£m biáº¿n siÃªu Ã¢m<br/>má»±c nÆ°á»›c"]
        RFID["RFID RC522"]
        LED["ÄÃ¨n LED"]
        PUMP["BÆ¡m 5V"]
        FAN["Quáº¡t 5V"]
        BUZ["CÃ²i bÃ¡o"]
        SERVO["Servo SG90"]
    end

    subgraph Node["ESP32 Firmware (PlatformIO)"]
        SENS["Module sensors.cpp<br/>Ä‘á»c & xá»­ lÃ½ cáº£m biáº¿n"]
        ACT["Module actuators.cpp<br/>Ä‘iá»u khiá»ƒn LED/Pump/Fan/Buzzer/Servo"]
        AUTO["automation.cpp<br/>luáº­t Ä‘iá»u khiá»ƒn tá»± Ä‘á»™ng"]
        WIFI["wifi_mqtt.cpp<br/>WiFi + MQTT TLS"]
        RFIDM["rfid.cpp<br/>Ä‘á»c UID tháº»"]
    end

    subgraph Cloud["EMQX Cloud<br/>MQTT Broker"]
        TOPIC["Topic smartfarm/data<br/>smartfarm/alert"]
    end

    subgraph PC["PC / Server"]
        NR["Node-RED<br/>Flows + Dashboard"]
        CSV["File CSV log"]
        EMAIL["Email server"]
        TG["Telegram Bot API"]
    end

    DHT --> SENS
    SOIL --> SENS
    GAS --> SENS
    FIRE --> SENS
    PIR --> SENS
    LDR --> SENS
    US --> SENS
    RFID --> RFIDM

    SENS --> AUTO
    RFIDM --> AUTO
    AUTO --> ACT

    ACT --> LED
    ACT --> PUMP
    ACT --> FAN
    ACT --> BUZ
    ACT --> SERVO

    WIFI <-.-> Cloud
    Cloud <-.-> NR
    NR --> CSV
    NR --> EMAIL
    NR --> TG
```

---

## 4. Pháº§n cá»©ng sá»­ dá»¥ng

> **LÆ°u Ã½:** chÃ¢n GPIO cÃ³ thá»ƒ thay Ä‘á»•i theo board cá»§a báº¡n.
> Xem láº¡i file `firmware/src/sensors.h` vÃ  `firmware/src/actuators.h` trong repo Ä‘á»ƒ biáº¿t cáº¥u hÃ¬nh chÃ­nh xÃ¡c.

| NhÃ³m                | Thiáº¿t bá»‹                   | MÃ´ táº£                           | Káº¿t ná»‘i (vÃ­ dá»¥)                                        |
| ------------------- | -------------------------- | ------------------------------- | ------------------------------------------------------ |
| MCU                 | ESP32 DevKit V1 (WROOM-32) | WiFi, nhiá»u chÃ¢n analog/digital | USB + cÃ¡c chÃ¢n GPIO                                    |
| Cáº£m biáº¿n mÃ´i trÆ°á»ng | DHT11                      | Nhiá»‡t Ä‘á»™, Ä‘á»™ áº©m                 | Data â†’ GPIO 4                                          |
|                     | Cáº£m biáº¿n áº©m Ä‘áº¥t analog     | Äá»™ áº©m Ä‘áº¥t                       | AO â†’ GPIO 34 (ADC)                                     |
|                     | MQ135                      | Gas / cháº¥t lÆ°á»£ng khÃ´ng khÃ­      | AO â†’ GPIO 35 (ADC)                                     |
|                     | Cáº£m biáº¿n lá»­a               | PhÃ¡t hiá»‡n lá»­a (active LOW)      | DO â†’ GPIO 32                                           |
|                     | PIR                        | PhÃ¡t hiá»‡n ngÆ°á»i                 | DO â†’ GPIO 27                                           |
|                     | LDR module                 | PhÃ¡t hiá»‡n sÃ¡ng/tá»‘i              | DO â†’ GPIO 14                                           |
|                     | HC-SR04                    | Äo má»±c nÆ°á»›c                     | Trig â†’ GPIO 25, Echo â†’ GPIO 26                         |
| Nháº­n dáº¡ng           | RC522 RFID                 | Äá»c UID tháº»                     | SDA â†’ GPIO 5, SCK â†’ 18, MOSI â†’ 23, MISO â†’ 19, RST â†’ 22 |
| Thá»±c thi            | LED                        | MÃ´ phá»ng Ä‘Ã¨n chiáº¿u sÃ¡ng         | GPIO 2 (on-board LED)                                  |
|                     | BÆ¡m 5V                     | TÆ°á»›i nÆ°á»›c / chá»¯a chÃ¡y           | Qua relay 5V IN1 â†’ GPIO 16 (vÃ­ dá»¥)                     |
|                     | Quáº¡t 5V                    | ThÃ´ng giÃ³ / hÃºt khÃ­             | Qua relay 5V IN2 â†’ GPIO 21 (vÃ­ dá»¥)                     |
|                     | CÃ²i buzzer                 | Cáº£nh bÃ¡o chÃ¡y / RFID            | GPIO 33                                                |
|                     | Servo SG90                 | QuÃ©t vÃ¹ng phÃ¡t hiá»‡n lá»­a         | GPIO 13 (PWM)                                          |
| Nguá»“n & giao tiáº¿p   | Relay 2 kÃªnh 5V            | Äiá»u khiá»ƒn quáº¡t + bÆ¡m           | VCC 5V, JD-VCC 5V, opto cÃ¡ch ly                        |
|                     | Nguá»“n 5V                   | Cáº¥p cho quáº¡t, bÆ¡m, servo, relay | 5V/2A trá»Ÿ lÃªn                                          |

---

## 5. Cáº¥u trÃºc thÆ° má»¥c repo

```text
.
â”œâ”€â”€ firmware/              # MÃ£ nguá»“n ESP32 (PlatformIO)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ main.cpp
â”‚   â”‚   â”œâ”€â”€ sensors.cpp / sensors.h
â”‚   â”‚   â”œâ”€â”€ actuators.cpp / actuators.h
â”‚   â”‚   â”œâ”€â”€ automation.cpp / automation.h
â”‚   â”‚   â”œâ”€â”€ wifi_mqtt.cpp / wifi_mqtt.h
â”‚   â”‚   â””â”€â”€ rfid.cpp / rfid.h
â”‚   â”œâ”€â”€ include/
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â””â”€â”€ ca.crt         # file CA certificate cho EMQX TLS
â”‚   â””â”€â”€ platformio.ini
â”‚
â”œâ”€â”€ nodered/
â”‚   â”œâ”€â”€ smartfarm_dashboard_flow.json   # flow dashboard + charts
â”‚   â””â”€â”€ smartfarm_alerts_flow.json      # flow email + telegram
â”‚
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ hardware_schematic.png          # sÆ¡ Ä‘á»“ Ä‘áº¥u ná»‘i
â”‚   â”œâ”€â”€ dashboard_overview.png          # áº£nh mÃ n hÃ¬nh dashboard
â”‚   â”œâ”€â”€ charts_overview.png             # áº£nh tab charts
â”‚   â””â”€â”€ video_demo.mp4                  # (tÃ¹y chá»n) video demo
â”‚
â””â”€â”€ README.md
```

---

## 6. CÃ i Ä‘áº·t & triá»ƒn khai

### 6.1. Firmware ESP32 (PlatformIO)

1. CÃ i **VSCode** + extension **PlatformIO**.

2. Clone repo:

   ```bash
   git clone https://github.com/ngokhanhhoa2905/smartfarm-esp32.git
   cd smartfarm-esp32/firmware
   ```

3. Má»Ÿ thÆ° má»¥c `firmware` báº±ng VSCode â†’ PlatformIO sáº½ tá»± nháº­n project.

4. Sá»­a file cáº¥u hÃ¬nh WiFi & MQTT (vÃ­ dá»¥ trong `wifi_mqtt.h`):

   ```cpp
   const char* WIFI_SSID = "YourWiFi";
   const char* WIFI_PASS = "YourPassword";

   const char* mqtt_server = "rf51c8c2.ala.asia-southeast1.emqxsl.com";
   const int   mqtt_port   = 8883;   // TLS
   const char* mqtt_user   = "SmartFarm_ESP32";
   const char* mqtt_pass   = "12345678";
   ```

5. Copy file **CA certificate** (`ca.crt`) cá»§a EMQX vÃ o thÆ° má»¥c `firmware/data/` (nhÆ° Ä‘Ã£ lÃ m).

6. Upload SPIFFS chá»©a CA:

   * Má»Ÿ Terminal PlatformIO â†’ Run task: **Upload File System Image**.

7. Náº¡p firmware:

   * **Upload** (build + flash)
   * Má»Ÿ **Serial Monitor** 115200 Ä‘á»ƒ kiá»ƒm tra:

     * `CA certificate loaded successfully.`
     * `WiFi connected!`
     * `Connecting to MQTT... connected!`
     * `Published heartbeat` + cÃ¡c JSON data.

### 6.2. EMQX Cloud

* Táº¡o deployment EMQX Cloud (free).
* Báº­t **Authentication** dáº¡ng User/Password, táº¡o user `SmartFarm_ESP32`.
* Ghi láº¡i:

  * `Address` (host).
  * `MQTT over TLS/SSL Port` (8883).
  * CA certificate Ä‘á»ƒ dÃ¹ng cho ESP32.
* KhÃ´ng cáº§n cáº¥u hÃ¬nh thÃªm topic (dÃ¹ng máº·c Ä‘á»‹nh).

### 6.3. Node-RED + Dashboard

1. CÃ i Node-RED (npm hoáº·c Docker).

2. CÃ i thÃªm cÃ¡c node cáº§n thiáº¿t:

   ```bash
   cd ~/.node-red
   npm install node-red-dashboard
   npm install node-red-contrib-telegrambot
   ```

3. Khá»Ÿi Ä‘á»™ng Node-RED, vÃ o giao diá»‡n web (máº·c Ä‘á»‹nh `http://127.0.0.1:1880`).

4. Import flow dashboard:

   * Menu â†’ Import â†’ Clipboard
   * DÃ¡n ná»™i dung file `nodered/smartfarm_dashboard_flow.json`
   * Sá»­a node **MQTT broker** trá» vá» EMQX (giá»‘ng ESP32)
   * Deploy.

5. Import flow alert:

   * Menu â†’ Import â†’ Clipboard
   * DÃ¡n `nodered/smartfarm_alerts_flow.json`
   * Cáº¥u hÃ¬nh:

     * Node **Email** vá»›i tÃ i khoáº£n SMTP (vÃ­ dá»¥ Gmail App Password).
     * Node **Telegram bot** vá»›i bot token vÃ  chatId cá»§a báº¡n.
   * Deploy.

6. Má»Ÿ Dashboard:

   * `http://127.0.0.1:1880/ui`
   * Tab **SmartFarm Dashboard** & **SmartFarm Charts** & **SmartFarm Alerts**.

---

## 7. LÆ°u Ä‘á»“ thuáº­t toÃ¡n

### 7.1. LÆ°u Ä‘á»“ tá»•ng quÃ¡t vÃ²ng láº·p ESP32

```mermaid
flowchart TD
    A[Start] --> B[Khá»Ÿi táº¡o Serial]
    B --> C[initActuators()]
    C --> D[initSensors()]
    D --> E[initRFID()]
    E --> F[initWifiMQTT()]
    F --> G{Káº¿t ná»‘i WiFi & MQTT OK?}
    G -- No --> F
    G -- Yes --> H[Main loop]

    H --> I[ mqttLoop() ]
    I --> J[ readSensors() ]
    J --> K[ checkRFID() ]
    K --> L[ runAutomation(data, cardUID) ]
    L --> M{Äáº¿n chu ká»³ gá»­i dá»¯ liá»‡u?}
    M -- No --> I
    M -- Yes --> N[ÄÃ³ng gÃ³i JSON (data + tráº¡ng thÃ¡i)]
    N --> O[mqttPublish smartfarm/data]
    O --> I
```

### 7.2. LÆ°u Ä‘á»“ Ä‘iá»u khiá»ƒn tá»± Ä‘á»™ng (rÃºt gá»n)

```mermaid
flowchart TD
    A[Nháº­n SensorData d, cardUID] --> B{fire == true ?}
    B -- Yes --> B1[Báº­t cÃ²i, báº­t bÆ¡m, dá»«ng servo]
    B1 --> B2[Publish 'Fire detected']
    B2 --> C
    B -- No --> B3[Táº¯t cÃ²i, táº¯t bÆ¡m, servo tiáº¿p tá»¥c quÃ©t]
    B3 --> C

    C{gas% > ngÆ°á»¡ng OR (temp > 35 & motion)} --> C1[Báº­t quáº¡t] --> D
    C -- No --> C2[Táº¯t quáº¡t] --> D

    D{soil% < 30 AND water% > 20} --> D1[Báº­t bÆ¡m tÆ°á»›i] --> E
    D -- No --> D2[Táº¯t bÆ¡m] --> E

    E{motion == true AND light == tá»‘i} --> E1[Báº­t Ä‘Ã¨n] --> F
    E -- No --> E2[Táº¯t Ä‘Ã¨n] --> F

    F{cardUID != "" ?} -->|Yes| F1[Kiá»ƒm tra UID há»£p lá»‡?]
    F1 -- Há»£p lá»‡ --> F2[Log: Access OK]
    F1 -- Sai --> F3[Log: Access Denied]
    F2 --> G[HoÃ n thÃ nh vÃ²ng láº·p]
    F3 --> G
    F -- No --> G
```

---

## 8. HÆ°á»›ng dáº«n sá»­ dá»¥ng

1. **Báº­t nguá»“n há»‡ thá»‘ng:**

   * ESP32 khá»Ÿi Ä‘á»™ng, káº¿t ná»‘i WiFi & MQTT.
   * Relay, bÆ¡m, quáº¡t á»Ÿ tráº¡ng thÃ¡i an toÃ n (táº¯t).

2. **Má»Ÿ Node-RED Dashboard:**

   * `SmartFarm Dashboard`:

     * Quan sÃ¡t cÃ¡c gauge mÃ´i trÆ°á»ng thay Ä‘á»•i theo thá»i gian thá»±c.
     * Kiá»ƒm tra tráº¡ng thÃ¡i Fire / Motion / Light.
   * `SmartFarm Charts`:

     * Theo dÃµi lá»‹ch sá»­ gáº§n nháº¥t cá»§a 5 thÃ´ng sá»‘ chÃ­nh.
   * `SmartFarm Alerts`:

     * Xem **Last sent message**.
     * Báº¥m `ğŸ“¤ Send report now` Ä‘á»ƒ gá»­i bÃ¡o cÃ¡o thá»§ cÃ´ng.

3. **Test cÃ¡c ká»‹ch báº£n:**

   * **TÆ°á»›i nÆ°á»›c**:

     * LÃ m khÃ´ cáº£m biáº¿n Ä‘áº¥t â†’ soil% giáº£m â†’ bÆ¡m báº­t (náº¿u water% Ä‘á»§).
   * **Thiáº¿u nÆ°á»›c bá»ƒ**:

     * Háº¡ má»±c nÆ°á»›c (siÃªu Ã¢m) â†’ water% < 20 â†’ táº¯t bÆ¡m + cáº£nh bÃ¡o.
   * **Gas cao**:

     * DÃ¹ng khÃ³i nháº¹ / mÃ´ phá»ng â†’ gas% tÄƒng â†’ quáº¡t báº­t.
   * **ChÃ¡y**:

     * HÆ¡ lá»­a nhá» vÃ o cáº£m biáº¿n lá»­a â†’ cÃ²i kÃªu, bÆ¡m báº­t, servo dá»«ng, cáº£nh bÃ¡o gá»­i ngay.
   * **NgÆ°á»i ra vÃ o**:

     * Äi ngang PIR khi trá»i tá»‘i â†’ Ä‘Ã¨n LED báº­t.
   * **RFID**:

     * Quáº¹t tháº» Ä‘Ãºng/sai â†’ kiá»ƒm tra log rfid vÃ  hÃ nh vi cÃ²i (náº¿u cÃ³).

---

## 9. HÃ¬nh áº£nh & video minh hoáº¡

> Thay tháº¿ cÃ¡c Ä‘Æ°á»ng dáº«n báº±ng file thá»±c táº¿ cá»§a báº¡n trong thÆ° má»¥c `docs/`.

* **SÆ¡ Ä‘á»“ Ä‘áº¥u ná»‘i pháº§n cá»©ng**

  ![Hardware schematic](docs/hardware_schematic.png)

* **Giao diá»‡n Dashboard â€“ mÃ´i trÆ°á»ng & thiáº¿t bá»‹**

  ![Dashboard overview](docs/dashboard_overview.png)

* **Tab Charts â€“ cÃ¡c Ä‘á»“ thá»‹ thá»i gian thá»±c**

  ![Charts overview](docs/charts_overview.png)

* **Video demo há»‡ thá»‘ng:**

  [â–¶ Xem video demo](docs/video_demo.mp4)

---

## 10. Káº¿t luáº­n & HÆ°á»›ng phÃ¡t triá»ƒn

### 10.1. Káº¿t luáº­n

Dá»± Ã¡n **SmartFarm ESP32** Ä‘Ã£ hiá»‡n thá»±c:

* Má»™t há»‡ thá»‘ng **IoT nÃ´ng nghiá»‡p thÃ´ng minh**,
* Sá»­ dá»¥ng nhiá»u loáº¡i cáº£m biáº¿n, liÃªn káº¿t qua **MQTT Cloud**,
* CÃ³ **dashboard trá»±c quan** Ä‘á»ƒ quan sÃ¡t vÃ  ghi log,
* Äá»“ng thá»i tÃ­ch há»£p **cáº£nh bÃ¡o Ä‘a kÃªnh (Email + Telegram)**.

Há»‡ thá»‘ng Ä‘Ã¡p á»©ng tá»‘t yÃªu cáº§u cá»§a bÃ i táº­p lá»›n / Ä‘á»“ Ã¡n cuá»‘i ká»³:

* CÃ³ tÃ­nh á»©ng dá»¥ng thá»±c táº¿ vÃ o mÃ´ hÃ¬nh nÃ´ng tráº¡i nhá» / nhÃ  kÃ­nh.
* MÃ£ nguá»“n chia module rÃµ rÃ ng (`sensors`, `actuators`, `automation`, `wifi_mqtt`, `rfid`).
* TÃ i liá»‡u hoÃ¡ Ä‘áº§y Ä‘á»§: sÆ¡ Ä‘á»“, hÃ¬nh áº£nh, lÆ°u Ä‘á»“, hÆ°á»›ng dáº«n cÃ i Ä‘áº·t.

### 10.2. HÆ°á»›ng phÃ¡t triá»ƒn

Trong tÆ°Æ¡ng lai cÃ³ thá»ƒ má»Ÿ rá»™ng:

* TÃ­ch há»£p **cÆ¡ sá»Ÿ dá»¯ liá»‡u (InfluxDB, MongoDB, â€¦)** Ä‘á»ƒ lÆ°u trá»¯ dÃ i háº¡n.
* DÃ¹ng **Grafana** hoáº·c giao diá»‡n web riÃªng Ä‘á»ƒ trá»±c quan hoÃ¡ nÃ¢ng cao.
* ThÃªm thuáº­t toÃ¡n **tá»‘i Æ°u tÆ°á»›i** dá»±a trÃªn dá»± bÃ¡o thá»i tiáº¿t, lá»‹ch sá»­ Ä‘á»™ áº©m.
* Bá»• sung **AI/ML nhá»** dá»± Ä‘oÃ¡n sÃ¢u bá»‡nh hoáº·c phÃ¡t hiá»‡n báº¥t thÆ°á»ng.
* Há»— trá»£ cáº¥u hÃ¬nh tham sá»‘ (ngÆ°á»¡ng soil%, gas%, nhiá»‡t Ä‘á»™â€¦) trá»±c tiáº¿p tá»« dashboard.

---

## 11. ThÃ´ng tin tÃ¡c giáº£

* Há» tÃªn: *Ngo Khanh Hoa*
* MÃ´n há»c: *IoT Apps Dev*
* Giáº£ng viÃªn hÆ°á»›ng dáº«n: *TS. Nguyen Anh Tuan*
* LiÃªn há»‡: *ngokhanhhoa_t67@hus.edu.vn*

---
Video demo káº¿t quáº£
*https://www.youtube.com/watch?si=gxS6UQZpydUrsvZz&v=JBjc2BafbaU&feature=youtu.be*